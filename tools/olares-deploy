#!/bin/bash

set -e

KUBECTL="/tmp/kubectl"
NAMESPACE=$(cat /var/run/secrets/kubernetes.io/serviceaccount/namespace 2>/dev/null || echo "default")
OWNER=$(echo "$NAMESPACE" | sed 's/.*-//')

GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

function log_info() {
    echo -e "${GREEN}[âœ“]${NC} $1"
}

function log_error() {
    echo -e "${RED}[âœ—]${NC} $1"
}

function log_warning() {
    echo -e "${YELLOW}[!]${NC} $1"
}

function log_step() {
    echo -e "${BLUE}[â–¶]${NC} $1"
}

if [ $# -lt 3 ]; then
    log_error "å‚æ•°ä¸è¶³"
    echo "ç”¨æ³•: $0 <app-name> <image> <port> [command]"
    exit 1
fi

APP_NAME="$1"
IMAGE="$2"
PORT="$3"
COMMAND="${4:-}"

if ! [[ "$APP_NAME" =~ ^[a-z0-9-]+$ ]]; then
    log_error "åº”ç”¨åç§°æ— æ•ˆï¼š$APP_NAMEï¼ˆåªèƒ½åŒ…å«å°å†™å­—æ¯ã€æ•°å­—å’Œè¿å­—ç¬¦ï¼‰"
    exit 1
fi

log_step "å¼€å§‹éƒ¨ç½²åº”ç”¨"
echo "  åº”ç”¨åç§°: $APP_NAME"
echo "  é•œåƒ: $IMAGE"
echo "  ç«¯å£: $PORT"
echo "  Namespace: $NAMESPACE"
[ -n "$COMMAND" ] && echo "  å¯åŠ¨å‘½ä»¤: $COMMAND"

MANIFEST_FILE="/tmp/${APP_NAME}-deployment.yaml"

log_step "ç”Ÿæˆ Kubernetes manifest..."

if [ -n "$COMMAND" ]; then
    CONTAINER_COMMAND='
        command: ["/bin/sh", "-c"]
        args:
          - |
            '"$COMMAND"
else
    CONTAINER_COMMAND=''
fi

RANDOM_SUFFIX=$(echo $RANDOM | md5sum | head -c 8)
THIRD_LEVEL_DOMAIN="${RANDOM_SUFFIX}-${PORT}"

ENTRANCES_JSON="[{\"name\":\"${APP_NAME}\",\"host\":\"${APP_NAME}-svc\",\"port\":${PORT},\"title\":\"${APP_NAME}\",\"authLevel\":\"private\",\"openMethod\":\"default\"}]"
DOMAINS_JSON="[{\"appName\":\"${APP_NAME}\",\"entranceName\":\"${APP_NAME}\",\"thirdLevelDomain\":\"${THIRD_LEVEL_DOMAIN}\"}]"

cat > "$MANIFEST_FILE" <<EOF
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ${APP_NAME}
  namespace: ${NAMESPACE}
  labels:
    app: ${APP_NAME}
    deployed-by: opencode
    applications.app.bytetrade.io/name: ${APP_NAME}
    applications.app.bytetrade.io/owner: ${OWNER}
  annotations:
    meta.helm.sh/release-name: ${APP_NAME}
    meta.helm.sh/release-namespace: ${NAMESPACE}
    applications.app.bytetrade.io/entrances: '${ENTRANCES_JSON}'
    applications.app.bytetrade.io/default-thirdlevel-domains: '${DOMAINS_JSON}'
    applications.app.bytetrade.io/icon: https://app.cdn.olares.com/appstore/default/defaulticon.webp
    applications.app.bytetrade.io/title: ${APP_NAME}
spec:
  replicas: 1
  selector:
    matchLabels:
      app: ${APP_NAME}
  template:
    metadata:
      labels:
        app: ${APP_NAME}
      annotations:
        meta.helm.sh/release-name: ${APP_NAME}
        meta.helm.sh/release-namespace: ${NAMESPACE}
    spec:
      containers:
      - name: ${APP_NAME}
        image: ${IMAGE}${CONTAINER_COMMAND}
        workingDir: /app
        ports:
        - containerPort: ${PORT}
          name: http
        env:
        # Database configuration (auto-injected from Olares environment)
        - name: DB_HOST
          value: "${DB_HOST:-}"
        - name: DB_PORT
          value: "${DB_PORT:-5432}"
        - name: DB_USER
          value: "${DB_USER:-}"
        - name: DB_PASSWORD
          value: "${DB_PASSWORD:-}"
        - name: DB_DATABASE
          value: "${DB_DATABASE:-}"
        resources:
          requests:
            cpu: "100m"
            memory: "128Mi"
          limits:
            cpu: "500m"
            memory: "512Mi"
        volumeMounts:
        - name: workspace
          mountPath: /app
          subPath: ${APP_NAME}
      volumes:
      - name: workspace
        hostPath:
          path: /root/workspace
          type: DirectoryOrCreate
---
apiVersion: v1
kind: Service
metadata:
  name: ${APP_NAME}-svc
  namespace: ${NAMESPACE}
  labels:
    app: ${APP_NAME}
spec:
  type: ClusterIP
  selector:
    app: ${APP_NAME}
  ports:
  - port: ${PORT}
    targetPort: ${PORT}
    protocol: TCP
    name: http
EOF

log_info "Manifest å·²ç”Ÿæˆ: $MANIFEST_FILE"

log_step "éƒ¨ç½²åˆ° Kubernetes..."
if $KUBECTL apply -f "$MANIFEST_FILE" 2>&1; then
    log_info "éƒ¨ç½²æˆåŠŸï¼"
else
    log_error "éƒ¨ç½²å¤±è´¥"
    exit 1
fi

log_step "ç­‰å¾… Pod å¯åŠ¨..."
sleep 2

for i in {1..30}; do
    POD_STATUS=$($KUBECTL get pods -n "$NAMESPACE" -l app="$APP_NAME" -o jsonpath='{.items[0].status.phase}' 2>/dev/null || echo "")
    
    if [ "$POD_STATUS" = "Running" ]; then
        log_info "Pod å·²å¯åŠ¨"
        break
    elif [ "$POD_STATUS" = "Failed" ] || [ "$POD_STATUS" = "Error" ]; then
        log_error "Pod å¯åŠ¨å¤±è´¥"
        $KUBECTL get pods -n "$NAMESPACE" -l app="$APP_NAME"
        exit 1
    fi
    
    echo -n "."
    sleep 2
done
echo ""

if [ "$POD_STATUS" != "Running" ]; then
    log_warning "Pod æœªåœ¨é¢„æœŸæ—¶é—´å†…å¯åŠ¨ï¼Œå½“å‰çŠ¶æ€: $POD_STATUS"
fi

log_step "éƒ¨ç½²ä¿¡æ¯:"
echo ""
$KUBECTL get deployment "$APP_NAME" -n "$NAMESPACE"
echo ""
$KUBECTL get pods -n "$NAMESPACE" -l app="$APP_NAME"
echo ""
$KUBECTL get service "${APP_NAME}-svc" -n "$NAMESPACE"
echo ""

log_info "åº”ç”¨å·²éƒ¨ç½²å®Œæˆï¼"

# NOTE: VSCODE_PROXY_URI contains code-server domain (port 8080), NOT Nginx domain (port 3000)!
# The correct domain is the one user uses to access OpenCode UI.
# We cannot reliably detect it automatically, so provide a template.

echo ""
echo "  ğŸŒ è®¿é—®åœ°å€: https://{ä½ çš„OpenCodeåŸŸå}.${OWNER}.olares.com/${APP_NAME}/"
echo ""
echo "  ğŸ’¡ æç¤º: å°† {ä½ çš„OpenCodeåŸŸå} æ›¿æ¢ä¸ºä½ è®¿é—® OpenCode æ—¶çš„åŸŸåå‰ç¼€"
echo "     ä¾‹å¦‚: å¦‚æœä½ é€šè¿‡ https://8cf849020.onetest02.olares.com/ è®¿é—® OpenCode"
echo "     åˆ™åº”ç”¨åœ°å€ä¸º: https://8cf849020.${OWNER}.olares.com/${APP_NAME}/"
echo ""
echo "  ğŸ“ ä»£ç ç›®å½•: /root/workspace/${APP_NAME}"
echo ""
echo "  æŸ¥çœ‹æ—¥å¿—: olares-manage logs ${APP_NAME}"
echo "  åˆ é™¤åº”ç”¨: olares-manage delete ${APP_NAME}"
echo ""
