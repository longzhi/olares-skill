#!/usr/bin/env python3
"""
Olares Nginx Configuration Generator
为每个部署的应用自动生成 Nginx 反向代理配置

配置架构:
- /etc/nginx/conf.d/default.conf: 主配置，包含 include 和 location /
- /etc/nginx/conf.d/dev/*.conf: 每个应用的 location 配置
"""

import subprocess
import json
import sys
import os
from pathlib import Path

KUBECTL = "/tmp/kubectl"

def get_namespace():
    try:
        with open("/var/run/secrets/kubernetes.io/serviceaccount/namespace", "r") as f:
            return f.read().strip()
    except:
        return "default"

NAMESPACE = get_namespace()
NGINX_CONF_DIR = "/etc/nginx/conf.d/dev"
DEFAULT_CONF = "/etc/nginx/conf.d/default.conf"

DEFAULT_CONF_TEMPLATE = """server {
    listen 3000;
    server_name _;
    
    # 包含所有应用路由（必须在 location / 之前）
    include /etc/nginx/conf.d/dev/*.conf;
    
    # OpenCode Server 默认路由（兜底）
    location / {
        proxy_pass http://localhost:4096;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 超时设置 - 30分钟（匹配Olares平台）
        proxy_connect_timeout 1800s;
        proxy_send_timeout 1800s;
        proxy_read_timeout 1800s;
        send_timeout 1800s;
        
        # 禁用缓冲，支持流式响应
        proxy_buffering off;
        proxy_cache off;
    }
}
"""


def run_kubectl(args):
    """运行 kubectl 命令"""
    cmd = [KUBECTL] + args + ["-n", NAMESPACE]
    result = subprocess.run(cmd, capture_output=True, text=True)
    return result.returncode, result.stdout, result.stderr


def get_deployed_apps():
    """获取所有已部署的应用"""
    code, stdout, stderr = run_kubectl([
        "get", "deployments",
        "-l", "deployed-by=opencode",
        "-o", "json"
    ])
    
    if code != 0:
        print(f"错误：无法获取部署列表\n{stderr}", file=sys.stderr)
        return []
    
    data = json.loads(stdout)
    apps = []
    
    for item in data.get("items", []):
        name = item["metadata"]["name"]
        containers = item["spec"]["template"]["spec"]["containers"]
        port = containers[0]["ports"][0]["containerPort"] if containers and containers[0].get("ports") else None
        
        if port:
            apps.append({
                "name": name,
                "port": port,
                "service": f"{name}-svc.{NAMESPACE}.svc.cluster.local"
            })
    
    return apps


def generate_nginx_config(app):
    """为单个应用生成 Nginx 配置（只生成应用名路由，不生成端口路由）"""
    config = f"""# Auto-generated for {app['name']}
location /{app['name']}/ {{
    proxy_pass http://{app['service']}:{app['port']}/;
    proxy_http_version 1.1;
    
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $http_connection;
    
    proxy_connect_timeout 1800s;
    proxy_send_timeout 1800s;
    proxy_read_timeout 1800s;
    send_timeout 1800s;
    
    proxy_buffering off;
    proxy_request_buffering off;
}}
"""
    return config


def ensure_default_conf():
    """确保 default.conf 包含正确的 include 指令"""
    default_conf = Path(DEFAULT_CONF)
    
    if not default_conf.exists():
        print(f"✓ 创建 {DEFAULT_CONF}")
        default_conf.write_text(DEFAULT_CONF_TEMPLATE)
        return True
    
    content = default_conf.read_text()
    
    # 检查是否已包含 include 指令
    if "include /etc/nginx/conf.d/dev/*.conf" in content:
        return True
    
    # 需要更新 default.conf
    print(f"⚠️  更新 {DEFAULT_CONF} 以包含 include 指令")
    default_conf.write_text(DEFAULT_CONF_TEMPLATE)
    return True


def write_nginx_configs(apps):
    """写入所有 Nginx 配置"""
    # 确保配置目录存在
    Path(NGINX_CONF_DIR).mkdir(parents=True, exist_ok=True)
    
    # 清空旧配置
    for f in Path(NGINX_CONF_DIR).glob("*.conf"):
        f.unlink()
    
    # 写入应用配置
    for app in apps:
        config_file = Path(NGINX_CONF_DIR) / f"{app['name']}.conf"
        config_content = generate_nginx_config(app)
        config_file.write_text(config_content)
        print(f"✓ 生成配置: {config_file}")
    
    print(f"\n总共生成 {len(apps)} 个应用配置")
    
    # 确保 default.conf 正确
    ensure_default_conf()


def reload_nginx():
    """重载 Nginx 配置"""
    print("\n测试 Nginx 配置...")
    
    # 使用 kill -HUP 方式重载，避免日志文件问题
    result = subprocess.run(["pgrep", "-f", "nginx: master"], capture_output=True, text=True)
    
    if result.returncode != 0:
        # Nginx 未运行，启动它
        print("启动 Nginx...")
        result = subprocess.run(["nginx"], capture_output=True, text=True)
        if result.returncode == 0:
            print("✓ Nginx 启动成功")
            return True
        else:
            print(f"✗ Nginx 启动失败:\n{result.stderr}", file=sys.stderr)
            return False
    
    # Nginx 正在运行，重载配置
    pid = result.stdout.strip().split('\n')[0]
    print("重载 Nginx...")
    result = subprocess.run(["kill", "-HUP", pid], capture_output=True, text=True)
    if result.returncode == 0:
        print("✓ Nginx 重载成功")
        return True
    else:
        print(f"✗ Nginx 重载失败:\n{result.stderr}", file=sys.stderr)
        return False


def show_status():
    """显示 Nginx 状态"""
    print("\n" + "="*60)
    print("Nginx 代理状态")
    print("="*60)
    
    result = subprocess.run(["pgrep", "-a", "nginx"], capture_output=True, text=True)
    if result.returncode == 0:
        print(f"✓ Nginx 正在运行")
    else:
        print("✗ Nginx 未运行")
    
    result = subprocess.run(["ss", "-tlnp"], capture_output=True, text=True)
    nginx_ports = [line for line in result.stdout.split('\n') if 'nginx' in line.lower()]
    if nginx_ports:
        print("\nNginx 监听端口:")
        for line in nginx_ports:
            print(f"  {line}")


def main():
    if len(sys.argv) > 1 and sys.argv[1] == "status":
        show_status()
        return
    
    print("Olares Nginx 配置生成器")
    print("="*60)
    
    print("\n1. 扫描已部署的应用...")
    apps = get_deployed_apps()
    
    if not apps:
        print("  未找到已部署的应用")
        # 仍然确保 default.conf 正确
        ensure_default_conf()
        return
    
    print(f"  找到 {len(apps)} 个应用:")
    for app in apps:
        print(f"    - {app['name']} (端口 {app['port']})")
    
    print("\n2. 生成 Nginx 配置...")
    write_nginx_configs(apps)
    
    print("\n3. 应用配置...")
    if reload_nginx():
        show_status()
        print("\n✅ 配置完成！")
    else:
        print("\n❌ 配置失败")
        sys.exit(1)


if __name__ == "__main__":
    main()
